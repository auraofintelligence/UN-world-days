<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UN International Days — Year Calendar & .ICS Export</title>
<meta name="description" content="UN International Days calendar with monthly refresh, one-month-per-row layout, theme picker, font slider, and ICS export.">
<style>
  :root{
    /* defaults (Dark) */
    --bg:#0a1126; --panel:#101a34; --panel2:#0e1730; --grid:#1a2b57; --border:#2d4784;
    --text:#f2f6ff; --muted:#c2cdea; --accent:#44e0b4; --glow:#89ffe4;
    --chip:#1e3164; --chip-border:#3a5aa0; --num:#ffffff; /* day number */
    --fs:16px;
  }
  *{box-sizing:border-box; min-width:0}
  body{margin:0;background:radial-gradient(1200px 800px at 18% -10%,#142655 0,#0a1126 45%,#070e1e 100%);color:var(--text);font:var(--fs)/1.6 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu}
  header{position:sticky;top:0;z-index:50;background:rgba(10,17,38,.88);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{margin:0;font-size:calc(var(--fs) + 4px);letter-spacing:.2px}
  .controls{display:grid;grid-template-columns:1fr auto auto auto auto auto;gap:10px;margin-top:10px;align-items:center}
  .controls>*{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px}
  input[type="search"],select{width:100%;outline:none}
  input[type="range"]{width:140px}
  input[type="color"]{width:44px;height:36px;padding:4px;border-radius:10px;border:1px solid var(--border);background:var(--panel)}
  .inline{display:flex;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted)}
  button{cursor:pointer}
  .btn{transition:transform .12s ease, box-shadow .12s ease}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#a2f1dc);color:#061216;border:0;font-weight:700}
  .btn:hover{transform:translateY(-1px)}
  main .status{margin:14px 0 10px;color:var(--muted);display:flex;gap:16px;flex-wrap:wrap}
  a{color:var(--accent)}

  /* ===== One month per row ===== */
  .calendar{display:grid;grid-template-columns:1fr;gap:18px}
  .month{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden;position:relative;transition:transform .12s ease, box-shadow .15s ease, border-color .12s ease}
  .month h2{margin:0;font-size:calc(var(--fs) + 0px);padding:12px 14px;background:var(--panel2);border-bottom:1px solid var(--border);letter-spacing:.35px}
  .month:focus-within,.month:hover{transform:translateY(-1px);box-shadow:0 0 0 2px rgba(137,255,228,.28),0 0 26px rgba(137,255,228,.14)}

  /* 7 columns header + 7 columns × 6 rows body => uniform grid */
  .wk{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));grid-auto-rows:1fr;background:var(--grid)}
  .dow{background:var(--panel2);color:var(--muted);font-size:calc(var(--fs) - 4px);text-transform:uppercase;letter-spacing:.8px;padding:10px 8px;border-right:1px solid var(--border)}
  .dow:last-child{border-right:0}

  /* day cells */
  .d{background:var(--panel);border-right:1px solid var(--border);border-top:1px solid var(--border);
     padding:10px 8px;position:relative;display:flex;flex-direction:column;gap:6px;min-height:120px;
     outline:none;transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease}
  .d:nth-child(7n){border-right:0}
  .d .num{font-weight:800;font-size:calc(var(--fs) + 2px);letter-spacing:.2px;color:var(--num)}
  .d .events{display:flex;flex-direction:column;gap:6px;margin-top:2px}
  .chip,.more{
    display:block; font-size:calc(var(--fs) - 2px);
    background:var(--chip); border:1px solid var(--chip-border);
    border-radius:8px; padding:6px 8px;
    overflow-wrap:anywhere; word-break:break-word; white-space:normal;
  }
  .more{background:#253a74;border-color:#4d6cc0}
  .d:focus-visible,.d:hover{transform:translateY(-1px);box-shadow:0 0 0 2px rgba(137,255,228,.35),0 0 26px rgba(137,255,228,.18) inset}
  .d.today{box-shadow:0 0 0 2px rgba(255,209,96,.45),0 0 24px rgba(255,209,96,.25) inset}
  .d.inactive{opacity:.45}

  .legend{margin:8px 0 0;color:var(--muted);font-size:calc(var(--fs) - 3px)}
  .foot{margin:16px 0 36px;color:var(--muted)}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(5,10,18,.65);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:16px}
  .card{max-width:780px;width:min(780px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px}
  .card .wrap{padding:16px}
  .evlist{display:grid;gap:10px;margin:12px 0 4px}
  .ev{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--panel2)}
  .ev h3{margin:0 0 4px;font-size:calc(var(--fs) + 0px)}
  .ev .meta{color:var(--muted);font-size:calc(var(--fs) - 2px)}

  /* Add Event form */
  .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .formgrid .full{grid-column:1/-1}
  .formgrid input, .formgrid textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
  .danger{background:#3b1020;border-color:#6c1a39}
  .danger:hover{box-shadow:0 0 0 2px rgba(255,120,120,.25)}

  @media (max-width:980px){
    .controls{grid-template-columns:1fr 1fr 1fr;grid-auto-rows:auto}
    .controls :nth-child(1){grid-column:1/-1}
    .d{min-height:96px}
  }
  @media (prefers-reduced-motion:reduce){ .month,.d,.btn{transition:none} }
</style>
</head>
<body>
<header><div class="wrap">
  <h1>UN International Days — Annual Calendar</h1>
  <div class="controls">
    <input id="q" type="search" placeholder="Search (e.g., ‘Oceans’, ‘Refugee’, ‘Language’)" aria-label="Search observances">
    <select id="year" aria-label="Year selector"></select>
    <select id="theme" aria-label="Theme">
      <option value="dark" selected>Dark</option>
      <option value="light">Light</option>
      <option value="neon">Neon</option>
      <option value="hc">High Contrast</option>
    </select>
    <div class="inline" title="Accent colour"><label for="accent">Accent</label><input id="accent" type="color" value="#44e0b4"></div>
    <div class="inline" title="Text size"><label for="fs">Text</label><input id="fs" type="range" min="11" max="20" value="16"></div>
    <button id="add" class="btn">Add day</button>
    <button id="refresh" class="btn">Refresh</button>
    <button id="export" class="btn primary">Export .ics (year)</button>
  </div>
</div></header>

<main class="wrap">
  <div class="status">
    <div>Data source: <span id="source">—</span></div>
    <div>Last update: <span id="updated">—</span></div>
    <div><a href="https://www.un.org/en/observances/list-days-weeks" target="_blank" rel="noopener">Verify on UN.org</a></div>
  </div>

  <section id="calendar" class="calendar" aria-live="polite"></section>
  <div class="legend">Word-wrap is on; day numbers bright; drag the Text slider or change theme/accent. Click any day to expand. “Add day” stores locally and exports with .ics.</div>
</main>

<!-- Details modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="card">
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2 id="modal-date" style="margin:0;font-size:calc(var(--fs) + 2px)">Details</h2>
        <button id="close" class="btn">Close</button>
      </div>
      <div id="modal-body" class="evlist"></div>
    </div>
  </div>
</div>

<!-- Add event modal -->
<div id="addModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="card">
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2 style="margin:0;font-size:calc(var(--fs) + 2px)">Add custom day</h2>
        <button id="addClose" class="btn">Close</button>
      </div>
      <div class="formgrid" style="margin-top:8px">
        <input id="evTitle" class="full" placeholder="Title (e.g., Community Ocean Day)">
        <input id="evDate" type="date" title="Date">
        <input id="evUrl" placeholder="URL (optional)">
        <textarea id="evNote" class="full" rows="3" placeholder="Notes (optional)"></textarea>
        <div class="inline"><input id="evSave" class="btn primary" type="button" value="Save"></div>
        <div class="inline"><input id="evPurge" class="btn danger" type="button" value="Delete all custom days"></div>
      </div>
      <p class="legend">Custom days are stored only in your browser. They’ll appear on the calendar and in exported .ics.</p>
    </div>
  </div>
</div>

<script>
/* ===== Config & cache ===== */
const CACHE_KEY='un_days_cache_v1', CACHE_AT='un_days_cache_time_v1', CACHE_SRC='un_days_cache_source_v1';
const CUSTOM_KEY='un_days_custom_v1'; // array of {title,date,url,note}
const MAX_CACHE_AGE_DAYS=30;
const SOURCE_PRIMARY={name:'GitHub ICS (community)',type:'ics',url:'https://raw.githubusercontent.com/civilianEU/un-international-days/master/un-international-days.ics'};
const SOURCES=[SOURCE_PRIMARY];

/* Themes (palettes) */
const THEMES={
  dark:{bg:'#0a1126',panel:'#101a34',panel2:'#0e1730',grid:'#1a2b57',border:'#2d4784',text:'#f2f6ff',muted:'#c2cdea',accent:'#44e0b4',glow:'#89ffe4',chip:'#1e3164',chipb:'#3a5aa0',num:'#ffffff'},
  light:{bg:'#f6f8ff',panel:'#ffffff',panel2:'#f1f4ff',grid:'#dbe5ff',border:'#c4d1f5',text:'#0e1a33',muted:'#445b86',accent:'#147a6f',glow:'#36c3ad',chip:'#edf2ff',chipb:'#cfdcff',num:'#0e1a33'},
  neon:{bg:'#0a0018',panel:'#14022a',panel2:'#1a0438',grid:'#2a0b5c',border:'#3c1690',text:'#f5e8ff',muted:'#cfb8ff',accent:'#c86bff',glow:'#ff9dff',chip:'#2a0b5c',chipb:'#6c3ad6',num:'#ffffff'},
  hc:{bg:'#0b0b0b',panel:'#121212',panel2:'#0f0f0f',grid:'#1b1b1b',border:'#2a2a2a',text:'#ffffff',muted:'#d0d0d0',accent:'#35e6a8',glow:'#8affda',chip:'#1c1c1c',chipb:'#3a3a3a',num:'#ffffff'}
};

/* State */
const state={allEvents:[],byDate:new Map(),year:new Date().getFullYear(),query:'',custom:[]};

/* ===== Utils ===== */
const pad=n=>(n<10?'0':'')+n;
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const parseICSDate=s=>{const m=/^(\d{4})(\d{2})(\d{2})/.exec(s);return m?new Date(+m[1],+m[2]-1,+m[3]):null;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function unfoldICS(text){return text.replace(/\r\n|\r/g,'\n').split('\n').reduce((a,l)=>{if(l.startsWith(' ')||l.startsWith('\t'))a[a.length-1]+=l.slice(1);else a.push(l);return a;},[]).join('\n')}
function parseRRule(s){return s.split(';').reduce((o,p)=>{const i=p.indexOf('=');if(i>0)o[p.slice(0,i)]=p.slice(i+1);return o;},{})}
function nthWeekdayOfMonth(y,m,w,n){const f=new Date(y,m,1);const d=f.getDay();const delta=((w-d)+7)%7;const date=1+delta+(n-1)*7;const r=new Date(y,m,date);return r.getMonth()===m?r:null}
function lastWeekdayOfMonth(y,m,w){const last=new Date(y,m+1,0);const d=last.getDay();const delta=((d-w)+7)%7;return new Date(y,m+1,0-delta)}
function byDayTokenToIndex(t){return ['SU','MO','TU','WE','TH','FR','SA'].indexOf(t)}

/* ===== Parse + expand ===== */
function expandToYear(v,year){
  const out=[]; const r=v.rrule?parseRRule(v.rrule):null;
  const s0=v.dtstart?parseICSDate(v.dtstart):null, e0=v.dtend?parseICSDate(v.dtend):null;
  const span=(s0&&e0)?Math.max(1,Math.round((e0-s0)/86400000)):1;

  if(r&&r.FREQ==='YEARLY'){
    if(r.BYMONTH&&r.BYMONTHDAY){
      const s=new Date(year,+r.BYMONTH-1,+r.BYMONTHDAY);
      for(let i=0;i<span;i++) out.push({start:addDays(s,i),end:addDays(s,i+1)}); return out;
    }
    if(r.BYMONTH&&r.BYDAY){
      const m=+r.BYMONTH-1; const by=r.BYDAY.split(',')[0]; const w=byDayTokenToIndex(by.slice(-2));
      const pos=r.BYSETPOS?+r.BYSETPOS:1; const s=(pos===-1)?lastWeekdayOfMonth(year,m,w):nthWeekdayOfMonth(year,m,w,pos);
      if(s){for(let i=0;i<span;i++) out.push({start:addDays(s,i),end:addDays(s,i+1)}); return out;}
    }
  }
  if(s0){const s=new Date(year,s0.getMonth(),s0.getDate());for(let i=0;i<span;i++) out.push({start:addDays(s,i),end:addDays(s,i+1)});}
  return out;
}
function parseICS(text,srcName){
  const clean=unfoldICS(text);
  const blocks=clean.split('BEGIN:VEVENT').slice(1).map(b=>b.split('END:VEVENT')[0]);
  const events=[];
  for(const b of blocks){
    const prop=n=>{const m=b.match(new RegExp(`^${n}(?:;[^:]*)?:(.*)$`,'m'));return m?m[1].trim():null}
    events.push({summary:prop('SUMMARY')||'(Untitled)',dtstart:prop('DTSTART'),dtend:prop('DTEND'),
                 rrule:prop('RRULE'),url:prop('URL'),src:srcName,raw:b});
  }
  return events;
}

/* ===== Fetch + cache ===== */
async function fetchEvents(){
  for(const s of SOURCES){
    try{
      const res=await fetch(s.url,{cache:'no-store'}); if(!res.ok) throw new Error(res.status+' '+res.statusText);
      const text=await res.text(); const list=parseICS(text,s.name); if(list.length) return {list,source:s.name};
    }catch(e){ console.warn('Fetch failed',s.name,e); }
  }
  throw new Error('All sources failed. Try again later.');
}
function saveCache(list,source){
  localStorage.setItem(CACHE_KEY,JSON.stringify(list));
  localStorage.setItem(CACHE_AT,new Date().toISOString());
  localStorage.setItem(CACHE_SRC,source);
}
function loadCache(){
  try{
    const raw=localStorage.getItem(CACHE_KEY); if(!raw) return null;
    const when=new Date(localStorage.getItem(CACHE_AT)); const source=localStorage.getItem(CACHE_SRC)||'Unknown';
    const age=(Date.now()-when.getTime())/86400000; return {list:JSON.parse(raw),when,ageDays:age,source};
  }catch{ return null; }
}

/* ===== Custom days ===== */
function loadCustom(){ try{ return JSON.parse(localStorage.getItem(CUSTOM_KEY)||'[]'); }catch{ return [] } }
function saveCustom(arr){ localStorage.setItem(CUSTOM_KEY,JSON.stringify(arr)); }

/* ===== Build index (includes customs) ===== */
function buildIndex(list,year){
  const byDate=new Map(); const flat=[];

  function add(item){
    const key=ymd(item.dateStart);
    if(!byDate.has(key)) byDate.set(key,[]);
    byDate.get(key).push(item); flat.push(item);
  }

  // ICS
  for(const v of list){
    for(const o of expandToYear(v,year)){
      add({title:v.summary.replace(/\s+/g,' ').trim(),dateStart:o.start,dateEnd:o.end,src:v.src,url:v.url||''});
    }
  }
  // Custom
  for(const c of state.custom){
    const d=new Date(c.date);
    if(d.getFullYear()!==year) continue;
    add({title:c.title,dateStart:d,dateEnd:addDays(d,1),src:'Custom',url:c.url||'',note:c.note||''});
  }
  for(const arr of byDate.values()) arr.sort((a,b)=>a.title.localeCompare(b.title));
  return {byDate,materialized:flat};
}

/* ===== Render ===== */
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MAX_CHIPS=6; // now they wrap vertically, show more per cell

function renderYearOptions(){
  const sel=document.getElementById('year'); sel.innerHTML='';
  const nowY=new Date().getFullYear();
  for(let y=nowY-1;y<=nowY+4;y++){const o=document.createElement('option');o.value=y;o.textContent=y;if(y===state.year)o.selected=true;sel.appendChild(o);}
}

function renderCalendar(){
  const wrap=document.getElementById('calendar'); wrap.innerHTML='';
  const q=state.query.trim().toLowerCase(); const todayKey=ymd(new Date());

  for(let m=0;m<12;m++){
    const box=document.createElement('section'); box.className='month'; box.setAttribute('tabindex','-1');
    box.innerHTML=`<h2>${MONTHS[m]}</h2>`;
    const grid=document.createElement('div'); grid.className='wk';

    // DOW
    for(const wd of DOW){ const el=document.createElement('div'); el.className='dow'; el.textContent=wd; grid.appendChild(el); }

    const first=new Date(state.year,m,1);
    const padStart=(first.getDay()+7)%7;
    const daysInMonth=new Date(state.year,m+1,0).getDate();

    for(let i=0;i<padStart;i++){ const e=document.createElement('div'); e.className='d inactive'; e.setAttribute('aria-hidden','true'); grid.appendChild(e); }

    for(let d=1; d<=daysInMonth; d++){
      const cell=document.createElement('button'); cell.type='button'; cell.className='d';
      const cur=new Date(state.year,m,d); const key=ymd(cur); if(key===todayKey) cell.classList.add('today');
      const evs=state.byDate.get(key)||[];
      const visible=q ? evs.filter(e=>e.title.toLowerCase().includes(q)) : evs;

      const holder=document.createElement('div'); holder.className='events';
      const shown=visible.slice(0,MAX_CHIPS);
      shown.forEach(e=>{ const chip=document.createElement('span'); chip.className='chip'; chip.title=e.title; chip.textContent=e.title; holder.appendChild(chip); });
      if(visible.length>MAX_CHIPS){ const more=document.createElement('span'); more.className='more'; more.textContent=`+${visible.length-MAX_CHIPS} more`; holder.appendChild(more); }
      if(evs.length && !visible.length) cell.classList.add('inactive');

      cell.addEventListener('click',()=>{ if(visible.length) showModal(key,visible); });

      cell.innerHTML=`<div class="num">${d}</div>`; cell.appendChild(holder); grid.appendChild(cell);
    }
    const cellsSoFar=padStart+daysInMonth;
    for(let i=cellsSoFar;i<42;i++){ const e=document.createElement('div'); e.className='d inactive'; e.setAttribute('aria-hidden','true'); grid.appendChild(e); }

    box.appendChild(grid); wrap.appendChild(box);
  }
}

/* ===== Details modal ===== */
function showModal(key,list){
  const d=new Date(key);
  document.getElementById('modal-date').textContent=d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const body=document.getElementById('modal-body'); body.innerHTML='';
  for(const e of list){
    const range=(+e.dateEnd-+e.dateStart>86400000)?' – '+addDays(e.dateEnd,-1).toLocaleDateString():'';
    const div=document.createElement('div'); div.className='ev';
    const delBtn=(e.src==='Custom')?`<div><button class="btn danger" data-del="${e.title}##${ymd(e.dateStart)}">Remove</button></div>`:'';
    div.innerHTML=`<h3>${e.title}</h3><div class="meta">${e.dateStart.toLocaleDateString()}${range} • <em>${e.src}</em></div>${e.url?`<div><a href="${e.url}" target="_blank" rel="noopener">More info</a></div>`:''}${delBtn}`;
    body.appendChild(div);
  }
  // wire delete buttons (custom only)
  body.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const [title, ymdStr]=btn.getAttribute('data-del').split('##');
      state.custom=state.custom.filter(c=>!(c.title===title && c.date===ymdStr));
      saveCustom(state.custom); const c=loadCache(); if(c) apply(c.list);
      hideModal();
    });
  });
  const modal=document.getElementById('modal'); modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}
function hideModal(){const m=document.getElementById('modal'); m.style.display='none'; m.setAttribute('aria-hidden','true');}

/* ===== Add event modal ===== */
function showAdd(){document.getElementById('addModal').style.display='flex'; document.getElementById('addModal').setAttribute('aria-hidden','false');}
function hideAdd(){document.getElementById('addModal').style.display='none'; document.getElementById('addModal').setAttribute('aria-hidden','true');}

/* ===== Export ICS ===== */
function foldICSLines(s){return s.split('\n').map(line=>{if(line.length<=74)return line;let out='',i=0;while(i<line.length){out+=line.slice(i,i+74)+(i+74<line.length?'\r\n ':'');i+=74}return out}).join('\n')}
function toICS(){
  const year=state.year, items=[], seen=new Set();
  for(const arr of state.byDate.values()){
    for(const e of arr){
      if(e.dateStart.getFullYear()!==year) continue;
      const key=e.title+'#'+ymd(e.dateStart); if(seen.has(key)) continue; seen.add(key);
      const DTSTART=`${e.dateStart.getFullYear()}${pad(e.dateStart.getMonth()+1)}${pad(e.dateStart.getDate())}`;
      const DTEND =`${e.dateEnd.getFullYear()}${pad(e.dateEnd.getMonth()+1)}${pad(e.dateEnd.getDate())}`;
      const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@un-days`;
      const desc=(e.src==='Custom'&&e.note)?`${e.title} — ${e.note}`:`${e.title} — UN International Day`;
      items.push(['BEGIN:VEVENT',`UID:${uid}`,`SUMMARY:${e.title}`,`DTSTART;VALUE=DATE:${DTSTART}`,`DTEND;VALUE=DATE:${DTEND}`,`DESCRIPTION:${desc}`,e.url?`URL:${e.url}`:'','END:VEVENT'].filter(Boolean).join('\n'));
    }
  }
  const ical=['BEGIN:VCALENDAR','PRODID:-//UN International Days Calendar//EN','VERSION:2.0','CALSCALE:GREGORIAN',`X-WR-CALNAME:UN International Days (${year})`,...items,'END:VCALENDAR'].join('\n');
  const blob=new Blob([foldICSLines(ical)],{type:'text/calendar;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`UN_International_Days_${year}.ics`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1200);
}

/* ===== Load flow ===== */
function setStatus(source,when){document.getElementById('source').textContent=source; document.getElementById('updated').textContent=when.toLocaleString();}
function apply(list){const {byDate,materialized}=buildIndex(list,state.year); state.byDate=byDate; state.allEvents=materialized; renderCalendar();}
async function ensureData({force=false}={}){
  const cached=loadCache();
  if(!force && cached && cached.list?.length && cached.ageDays<=MAX_CACHE_AGE_DAYS){ setStatus(cached.source,cached.when); apply(cached.list); return; }
  setStatus('Fetching…', new Date()); const {list,source}=await fetchEvents(); saveCache(list,source); setStatus(source,new Date()); apply(list);
}

/* ===== Theme + UI wiring ===== */
function applyTheme(name){
  const t={...(THEMES[name]||THEMES.dark)};
  const accentPicker=document.getElementById('accent'); if(accentPicker.value) t.accent=accentPicker.value;
  const r=document.documentElement.style;
  r.setProperty('--bg',t.bg); r.setProperty('--panel',t.panel); r.setProperty('--panel2',t.panel2);
  r.setProperty('--grid',t.grid); r.setProperty('--border',t.border);
  r.setProperty('--text',t.text); r.setProperty('--muted',t.muted);
  r.setProperty('--accent',t.accent); r.setProperty('--glow',t.glow);
  r.setProperty('--chip',t.chip); r.setProperty('--chip-border',t.chipb);
  r.setProperty('--num',t.num);
  // swap body background for light
  document.body.style.background = (name==='light') ? '#f6f8ff' : 'radial-gradient(1200px 800px at 18% -10%,#142655 0,#0a1126 45%,#070e1e 100%)';
}
function applyFont(px){ document.documentElement.style.setProperty('--fs', px+'px'); }

document.getElementById('year').addEventListener('change',e=>{state.year=+e.target.value;const c=loadCache(); if(c) apply(c.list);});
document.getElementById('q').addEventListener('input',e=>{state.query=e.target.value; renderCalendar();});
document.getElementById('refresh').addEventListener('click',()=>ensureData({force:true}).catch(err=>alert(err.message)));
document.getElementById('export').addEventListener('click',toICS);
document.getElementById('close').addEventListener('click',hideModal);
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal') hideModal();});

document.getElementById('theme').addEventListener('change',e=>applyTheme(e.target.value));
document.getElementById('accent').addEventListener('input',()=>applyTheme(document.getElementById('theme').value));
document.getElementById('fs').addEventListener('input',e=>applyFont(e.target.value));

document.getElementById('add').addEventListener('click',showAdd);
document.getElementById('addClose').addEventListener('click',hideAdd);
document.getElementById('addModal').addEventListener('click',e=>{if(e.target.id==='addModal') hideAdd();});
document.getElementById('evSave').addEventListener('click',()=>{
  const title=document.getElementById('evTitle').value.trim();
  const date=document.getElementById('evDate').value;
  if(!title||!date){ alert('Please enter a title and date.'); return; }
  const url=document.getElementById('evUrl').value.trim();
  const note=document.getElementById('evNote').value.trim();
  state.custom.push({title,date,url,note}); saveCustom(state.custom);
  const c=loadCache(); if(c) apply(c.list); hideAdd();
});
document.getElementById('evPurge').addEventListener('click',()=>{
  if(confirm('Delete ALL custom days?')){ state.custom=[]; saveCustom(state.custom); const c=loadCache(); if(c) apply(c.list); }
});

/* ===== Init ===== */
(function init(){
  state.custom=loadCustom();
  renderYearOptions();
  applyTheme('dark'); applyFont(16);
  ensureData().catch(err=>{console.error(err); alert('Could not load observances.');});
})();
</script>
</body>
</html>

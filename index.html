<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UN International Days — Year Calendar & .ICS Export</title>
<meta name="description" content="UN International Days calendar with monthly refresh, neon highlights, and ICS export.">
<style>
  :root{
    --bg:#0a1020; --panel:#111a2c; --panel2:#0f1830; --grid:#1a2744;
    --text:#eaf1ff; --muted:#a9b8d6; --border:#24365c; --accent:#33d6a6; --glow:#75ffd9; --warn:#ffb020;
    --chip:#1c2b4d; --chip-border:#2a3f6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#0e1b3a 0,#0a1020 40%,#070d1a 100%);color:var(--text);font:15px/1.55 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu}
  header{position:sticky;top:0;z-index:50;background:rgba(10,16,32,.85);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{margin:0;font-size:19px;letter-spacing:.2px}
  .controls{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;margin-top:10px}
  .controls>*{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px}
  input[type="search"],select{width:100%;outline:none}
  button{cursor:pointer}
  .btn{transition:transform .12s ease, box-shadow .12s ease}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#8be1ca);color:#041015;border:0;font-weight:700}
  .btn:hover{transform:translateY(-1px)}
  main .status{margin:14px 0 10px;color:var(--muted);display:flex;gap:16px;flex-wrap:wrap}
  a{color:var(--accent)}
  /* Calendar grid */
  .calendar{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .month{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;position:relative;transition:transform .12s ease, box-shadow .15s ease, border-color .12s ease}
  .month h2{margin:0;font-size:14px;padding:10px 12px;background:var(--panel2);border-bottom:1px solid var(--border);letter-spacing:.35px}
  .month:focus-within, .month:hover{transform:translateY(-1px);box-shadow:0 0 0 2px rgba(51,214,166,.25), 0 0 22px rgba(117,255,217,.16)}
  /* 7 columns, fixed 6 week rows for uniform height */
  .wk{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:1fr;background:var(--grid)}
  .dow{background:var(--panel2);color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.8px;padding:8px 6px;border-right:1px solid var(--border)}
  .dow:last-child{border-right:0}
  .d{background:var(--panel);border-right:1px solid var(--border);border-top:1px solid var(--border);padding:8px 6px;position:relative;display:flex;flex-direction:column;gap:6px;min-height:86px;outline:none;transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease}
  .d:nth-child(7n){border-right:0}
  .d .num{font-weight:700;opacity:.95}
  .d .events{display:flex;flex-wrap:wrap;gap:4px;margin-top:2px}
  .chip, .more{font-size:11px;background:var(--chip);border:1px solid var(--chip-border);border-radius:999px;padding:3px 7px;white-space:nowrap;max-width:100%;overflow:hidden;text-overflow:ellipsis}
  /* Neon bump */
  .d:focus-visible, .d:hover{transform:translateY(-1px);box-shadow:0 0 0 2px rgba(117,255,217,.35), 0 0 26px rgba(117,255,217,.18) inset}
  .d.today{box-shadow:0 0 0 2px rgba(253,224,71,.3), 0 0 24px rgba(253,224,71,.2) inset}
  .d.inactive{opacity:.45}
  .legend{margin:10px 0 0;color:var(--muted);font-size:12px}
  .foot{margin:18px 0 40px;color:var(--muted)}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(5,10,18,.65);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:16px}
  .card{max-width:760px;width:min(760px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:14px}
  .card header{position:unset;background:transparent;border:0}
  .card .wrap{padding:16px}
  .evlist{display:grid;gap:10px;margin:10px 0 4px}
  .ev{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--panel2)}
  .ev h3{margin:0 0 4px;font-size:16px}
  .ev .meta{color:var(--muted);font-size:12px}
  @media (max-width:980px){ .calendar{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:680px){ .controls{grid-template-columns:1fr} .calendar{grid-template-columns:1fr} .d{min-height:72px} }
  @media (prefers-reduced-motion: reduce){
    .month, .d, .btn{transition:none}
  }
</style>
</head>
<body>
<header><div class="wrap">
  <h1>UN International Days — Annual Calendar</h1>
  <div class="controls">
    <input id="q" type="search" placeholder="Search (e.g., ‘Oceans’, ‘Refugee’, ‘Language’)" aria-label="Search observances">
    <select id="year" aria-label="Year selector"></select>
    <button id="refresh" class="btn">Refresh from web</button>
    <button id="export" class="btn primary">Export .ics (year)</button>
  </div>
</div></header>

<main class="wrap">
  <div class="status">
    <div>Data source: <span id="source">—</span></div>
    <div>Last update: <span id="updated">—</span></div>
    <div><a href="https://www.un.org/en/observances/list-days-weeks" target="_blank" rel="noopener">Verify on UN.org</a></div>
  </div>

  <section id="calendar" class="calendar" aria-live="polite"></section>
  <div class="legend">Tip: hover or tab to a day to see the neon outline; click any day (or press Enter) to open details. Search filters the year.</div>
  <p class="foot">Uniform months (6-week grids) keep the layout steady. Cells show up to three observances; “+N more” opens the details.</p>
</main>

<!-- Detail modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="card">
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2 id="modal-date" style="margin:0;font-size:17px">Details</h2>
        <button id="close" class="btn">Close</button>
      </div>
      <div id="modal-body" class="evlist"></div>
    </div>
  </div>
</div>

<script>
/* ===== Config & cache ===== */
const CACHE_KEY='un_days_cache_v1', CACHE_AT='un_days_cache_time_v1', CACHE_SRC='un_days_cache_source_v1';
const MAX_CACHE_AGE_DAYS=30;
const SOURCE_PRIMARY={name:'GitHub ICS (community)',type:'ics',url:'https://raw.githubusercontent.com/civilianEU/un-international-days/master/un-international-days.ics'};
const SOURCES=[SOURCE_PRIMARY];

const state={allEvents:[],byDate:new Map(),year:new Date().getFullYear(),query:''};

/* ===== Utils ===== */
const pad=n=>(n<10?'0':'')+n;
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const parseICSDate=s=>{const m=/^(\d{4})(\d{2})(\d{2})/.exec(s);return m?new Date(+m[1],+m[2]-1,+m[3]):null;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function unfoldICS(text){return text.replace(/\r\n|\r/g,'\n').split('\n').reduce((a,l)=>{if(l.startsWith(' ')||l.startsWith('\t'))a[a.length-1]+=l.slice(1);else a.push(l);return a;},[]).join('\n')}
function parseRRule(s){return s.split(';').reduce((o,p)=>{const i=p.indexOf('=');if(i>0)o[p.slice(0,i)]=p.slice(i+1);return o;},{})}
function nthWeekdayOfMonth(y,m,w,n){const f=new Date(y,m,1);const d=f.getDay();const delta=((w-d)+7)%7;const date=1+delta+(n-1)*7;const r=new Date(y,m,date);return r.getMonth()===m?r:null}
function lastWeekdayOfMonth(y,m,w){const last=new Date(y,m+1,0);const d=last.getDay();const delta=((d-w)+7)%7;return new Date(y,m+1,0-delta)}
function byDayTokenToIndex(t){return ['SU','MO','TU','WE','TH','FR','SA'].indexOf(t)}

/* ===== Parse + expand ===== */
function expandToYear(v,year){
  const out=[]; const r=v.rrule?parseRRule(v.rrule):null;
  const s0=v.dtstart?parseICSDate(v.dtstart):null, e0=v.dtend?parseICSDate(v.dtend):null;
  const span=(s0&&e0)?Math.max(1,Math.round((e0-s0)/86400000)):1;

  if(r&&r.FREQ==='YEARLY'){
    if(r.BYMONTH&&r.BYMONTHDAY){
      const m=+r.BYMONTH-1, d=+r.BYMONTHDAY, s=new Date(year,m,d);
      for(let i=0;i<span;i++) out.push({start:addDays(s,i),end:addDays(s,i+1)}); return out;
    }
    if(r.BYMONTH&&r.BYDAY){
      const m=+r.BYMONTH-1; const by=r.BYDAY.split(',')[0]; const w=byDayTokenToIndex(by.slice(-2));
      const pos=r.BYSETPOS?+r.BYSETPOS:1; const s=(pos===-1)?lastWeekdayOfMonth(year,m,w):nthWeekdayOfMonth(year,m,w,pos);
      if(s){for(let i=0;i<span;i++) out.push({start:addDays(s,i),end:addDays(s,i+1)}); return out;}
    }
  }
  if(s0){const s=new Date(year,s0.getMonth(),s0.getDate());for(let i=0;i<span;i++) out.push({start:addDays(s,i),end:addDays(s,i+1)});}
  return out;
}
function parseICS(text,srcName){
  const clean=unfoldICS(text);
  const blocks=clean.split('BEGIN:VEVENT').slice(1).map(b=>b.split('END:VEVENT')[0]);
  const events=[];
  for(const b of blocks){
    const prop=n=>{const m=b.match(new RegExp(`^${n}(?:;[^:]*)?:(.*)$`,'m'));return m?m[1].trim():null}
    events.push({summary:prop('SUMMARY')||'(Untitled)',dtstart:prop('DTSTART'),dtend:prop('DTEND'),
                 rrule:prop('RRULE'),url:prop('URL'),src:srcName,raw:b});
  }
  return events;
}

/* ===== Fetch + cache ===== */
async function fetchEvents(){
  for(const s of SOURCES){
    try{
      const res=await fetch(s.url,{cache:'no-store'}); if(!res.ok) throw new Error(res.status+' '+res.statusText);
      const text=await res.text(); const list=parseICS(text,s.name); if(list.length) return {list,source:s.name};
    }catch(e){ console.warn('Fetch failed',s.name,e); }
  }
  throw new Error('All sources failed. Try again later.');
}
function saveCache(list,source){
  localStorage.setItem(CACHE_KEY,JSON.stringify(list));
  localStorage.setItem(CACHE_AT,new Date().toISOString());
  localStorage.setItem(CACHE_SRC,source);
}
function loadCache(){
  try{
    const raw=localStorage.getItem(CACHE_KEY); if(!raw) return null;
    const when=new Date(localStorage.getItem(CACHE_AT)); const source=localStorage.getItem(CACHE_SRC)||'Unknown';
    const age=(Date.now()-when.getTime())/86400000; return {list:JSON.parse(raw),when,ageDays:age,source};
  }catch{ return null; }
}

/* ===== Build index ===== */
function buildIndex(list,year){
  const byDate=new Map(); const flat=[];
  for(const v of list){
    for(const o of expandToYear(v,year)){
      const key=ymd(o.start);
      const item={title:v.summary.replace(/\s+/g,' ').trim(),dateStart:o.start,dateEnd:o.end,src:v.src,url:v.url||''};
      if(!byDate.has(key)) byDate.set(key,[]);
      byDate.get(key).push(item); flat.push(item);
    }
  }
  for(const arr of byDate.values()) arr.sort((a,b)=>a.title.localeCompare(b.title));
  return {byDate,materialized:flat};
}

/* ===== Render ===== */
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DOW=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function renderYearOptions(){
  const sel=document.getElementById('year'); sel.innerHTML='';
  const nowY=new Date().getFullYear();
  for(let y=nowY-1;y<=nowY+4;y++){const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===state.year)o.selected=true; sel.appendChild(o);}
}

/* capped chips per cell for uniform heights */
const MAX_CHIPS=3;

function renderCalendar(){
  const wrap=document.getElementById('calendar'); wrap.innerHTML='';
  const q=state.query.trim().toLowerCase(); const todayKey=ymd(new Date());

  for(let m=0;m<12;m++){
    const box=document.createElement('section'); box.className='month'; box.setAttribute('tabindex','-1');
    box.innerHTML=`<h2>${MONTHS[m]}</h2>`;
    const grid=document.createElement('div'); grid.className='wk';

    // 7 DOW headers
    for(const wd of DOW){ const el=document.createElement('div'); el.className='dow'; el.textContent=wd; grid.appendChild(el); }

    const first=new Date(state.year,m,1); const padStart=(first.getDay()+7)%7; const daysInMonth=new Date(state.year,m+1,0).getDate();
    // leading empties to align first week
    for(let i=0;i<padStart;i++){const e=document.createElement('div'); e.className='d inactive'; e.setAttribute('aria-hidden','true'); grid.appendChild(e);}

    // days (we’ll still render up to 6 weeks total by adding trailing empties below)
    for(let d=1; d<=daysInMonth; d++){
      const cell=document.createElement('button'); cell.type='button'; cell.className='d'; cell.setAttribute('aria-label',`Open ${MONTHS[m]} ${d}`);
      const cur=new Date(state.year,m,d); const key=ymd(cur); if(key===todayKey) cell.classList.add('today');
      const evs=state.byDate.get(key)||[];
      const all= q ? evs.filter(e=>e.title.toLowerCase().includes(q)) : evs;

      const holder=document.createElement('div'); holder.className='events';
      const shown=all.slice(0,MAX_CHIPS);
      shown.forEach(e=>{ const chip=document.createElement('span'); chip.className='chip'; chip.title=e.title; chip.textContent=e.title; holder.appendChild(chip); });
      if(all.length>MAX_CHIPS){ const more=document.createElement('span'); more.className='more'; more.textContent=`+${all.length-MAX_CHIPS} more`; holder.appendChild(more); }
      if(evs.length && !all.length) cell.classList.add('inactive');

      cell.addEventListener('click',()=>{ if(all.length) showModal(key,all); });
      cell.addEventListener('keydown',e=>{ if(e.key==='Enter'&&all.length) showModal(key,all); });

      cell.innerHTML=`<div class="num">${d}</div>`; cell.appendChild(holder); grid.appendChild(cell);
    }

    // trailing empties to complete a 6-week grid (42 cells + 7 dow)
    const cellsSoFar=padStart+daysInMonth; const totalCells=42;
    for(let i=cellsSoFar;i<totalCells;i++){const e=document.createElement('div'); e.className='d inactive'; e.setAttribute('aria-hidden','true'); grid.appendChild(e);}

    box.appendChild(grid); wrap.appendChild(box);
  }
}

/* ===== Modal ===== */
function showModal(key,list){
  const d=new Date(key);
  document.getElementById('modal-date').textContent=d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const body=document.getElementById('modal-body'); body.innerHTML='';
  for(const e of list){
    const when=`${e.dateStart.toLocaleDateString()}${(+e.dateEnd-+e.dateStart>86400000?' – '+addDays(e.dateEnd,-1).toLocaleDateString():'')}`;
    const div=document.createElement('div'); div.className='ev';
    div.innerHTML=`<h3>${e.title}</h3><div class="meta">${when}</div>${e.url?`<div><a href="${e.url}" target="_blank" rel="noopener">More info</a></div>`:''}<div class="meta">Source: ${e.src}</div>`;
    body.appendChild(div);
  }
  const modal=document.getElementById('modal'); modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}
function hideModal(){const m=document.getElementById('modal'); m.style.display='none'; m.setAttribute('aria-hidden','true');}

/* ===== Export ICS ===== */
function foldICSLines(s){return s.split('\n').map(line=>{if(line.length<=74)return line;let out='',i=0;while(i<line.length){out+=line.slice(i,i+74)+(i+74<line.length?'\r\n ':'');i+=74}return out}).join('\n')}
function toICS(){
  const year=state.year, items=[], seen=new Set();
  for(const arr of state.byDate.values()){
    for(const e of arr){
      if(e.dateStart.getFullYear()!==year) continue;
      const key=e.title+'#'+ymd(e.dateStart); if(seen.has(key)) continue; seen.add(key);
      const DTSTART=`${e.dateStart.getFullYear()}${pad(e.dateStart.getMonth()+1)}${pad(e.dateStart.getDate())}`;
      const DTEND =`${e.dateEnd.getFullYear()}${pad(e.dateEnd.getMonth()+1)}${pad(e.dateEnd.getDate())}`;
      const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@un-days`;
      items.push(['BEGIN:VEVENT',`UID:${uid}`,`SUMMARY:${e.title}`,`DTSTART;VALUE=DATE:${DTSTART}`,`DTEND;VALUE=DATE:${DTEND}`,`DESCRIPTION:${e.title} — UN International Day`,e.url?`URL:${e.url}`:'','END:VEVENT'].filter(Boolean).join('\n'));
    }
  }
  const ical=['BEGIN:VCALENDAR','PRODID:-//UN International Days Calendar//EN','VERSION:2.0','CALSCALE:GREGORIAN',`X-WR-CALNAME:UN International Days (${year})`,...items,'END:VCALENDAR'].join('\n');
  const blob=new Blob([foldICSLines(ical)],{type:'text/calendar;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`UN_International_Days_${year}.ics`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1200);
}

/* ===== Load flow ===== */
function setStatus(source,when){document.getElementById('source').textContent=source; document.getElementById('updated').textContent=when.toLocaleString();}
function apply(list){const {byDate,materialized}=buildIndex(list,state.year); state.byDate=byDate; state.allEvents=materialized; renderCalendar();}
async function ensureData({force=false}={}){
  const cached=loadCache();
  if(!force && cached && cached.list?.length && cached.ageDays<=MAX_CACHE_AGE_DAYS){ setStatus(cached.source,cached.when); apply(cached.list); return; }
  setStatus('Fetching…', new Date()); const {list,source}=await fetchEvents(); saveCache(list,source); setStatus(source,new Date()); apply(list);
}

/* ===== Wire UI ===== */
document.getElementById('year').addEventListener('change',e=>{state.year=+e.target.value;const c=loadCache(); if(c) apply(c.list);});
document.getElementById('q').addEventListener('input',e=>{state.query=e.target.value; renderCalendar();});
document.getElementById('refresh').addEventListener('click',()=>ensureData({force:true}).catch(err=>alert(err.message)));
document.getElementById('export').addEventListener('click',toICS);
document.getElementById('close').addEventListener('click',hideModal);
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal') hideModal();});

/* ===== Init ===== */
(function init(){ renderYearOptions(); ensureData().catch(err=>{console.error(err); alert('Could not load observances.');}); })();
</script>
</body>
</html>
